<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kolebri – The Game</title>
  <style>
    /* --- GLOBAL --------------------------- */
    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      touch-action:none;
      font-family:"Montserrat",sans-serif;
    }

    /* Das Canvas wird NICHT mehr über CSS skaliert, damit p5‑width/height
       exakt den sichtbaren Pixeln entsprechen.  */
    canvas{display:block;}
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
</head>
<body>
<script>
/* ----------------------------------------------------------
          KOLEBRI – THE GAME  (responsive fix edition)
   ---------------------------------------------------------- */

let bird, treeImg, upperTreeImg, pineconeImg, bgImg;
let newBird, newTreeImg, newUpperTreeImg, newPineconeImg, newBgImg;
let birdX, birdY, birdVelocity, gravity;
let trees = [];
let pinecones = [];
let score = 0;
let gameState = 'start';
let quiz = null;
let quizTimer = 0;
let obstaclesPassed = 0;
let quizFade = 0;
let hoverIndex = -1;
let scaleFactor = 1;
let confetti = [];
let correctAnswers = 0;
let totalQuestionsAnswered = 0;
let quizResultMessage = '';
let quizResultTimer = 0;
let shuffledQuestions = [];
let currentQuestionIndex = 0;
let obstaclePauseTimer = 0;
let restartDelayTimer = 0;
let gravityActive = false;
let startDelayTimer = 0;
let confettiPlayed = false;

const quizQuestions = [
  {question:"Welcher Baum verströmt im Sommer einen besonders süßen Duft?",options:["Birke","Ahorn","Linde","Tanne"],correct:2},
  {question:"Welcher Baum hat weiße, schimmernde Rinde?",options:["Buche","Birke","Eiche","Hainbuche"],correct:1},
  {question:"Welcher Baum verliert als Nadelbaum im Herbst seine Nadeln?",options:["Fichte","Kiefer","Tanne","Lärche"],correct:3},
  {question:"Welche Baumart bildet kleine „Propeller“-Samen aus?",options:["Eiche","Tulpenbaum","Ahorn","Hainbuche"],correct:2},
  {question:"Welcher Baum hat tief eingeschnittene Blätter und bildet Eicheln?",options:["Ahorn","Buche","Eiche","Kirsche"],correct:2},
  {question:"Welcher Baum hat auffällige, trompetenförmige Blüten?",options:["Linde","Tulpenbaum","Ahorn","Tanne"],correct:1},
  {question:"Welcher Baum ist mit Weihnachten besonders verbunden?",options:["Tanne","Birke","Kirsche","Linde"],correct:0},
  {question:"Welche Blätter sind herzförmig?",options:["Eichenblätter","Lindenblätter","Ahornblätter","Buchenblätter"],correct:1},
  {question:"Welche Baumart hat eine sehr dichte Krone und ledrige Blätter?",options:["Hainbuche","Ahorn","Kirsche","Birke"],correct:0},
  {question:"Welcher Baum ist im Frühling mit rosa oder weißen Blüten bedeckt?",options:["Tulpenbaum","Buche","Kirsche","Weide"],correct:2},
  {question:"Welche Baumart ist besonders biegsam und oft in Wassernähe zu finden?",options:["Linde","Birke","Weide","Buche"],correct:2},
  {question:"Wie viele unterschiedliche Baumarten kann man entlang des Lehrpfades entdecken?",options:["7","9","11","13"],correct:2},
  {question:"Welche Baumart ist sowohl in Baumraum 1, 2 als auch 3 vertreten?",options:["Tanne","Tulpenbaum","Birke","Kirsche"],correct:2},
  {question:"Wo beginnt der Baumlehrpfad?",options:["Bei der Turnhalle","Beim Schulbüro","Beim JUZ / Parkplatz","Beim Fußballfeld"],correct:2},
  {question:"Welche Baumart hat eine besonders glatte und graue Rinde?",options:["Hainbuche","Buche","Eiche","Ahorn"],correct:1}
];

/* ------------------   PRELOAD   ------------------------- */
function preload(){
  bgImg          = tryLoad('./background.jpg',  'https://images.pexels.com/photos/38136/pexels-photo-38136.jpeg');
  treeImg        = tryLoad('./stammunten.png', 'https://images.pexels.com/photos/1612351/pexels-photo-1612351.jpeg');
  upperTreeImg   = tryLoad('./stammoben.png',  'https://images.pexels.com/photos/164353/pexels-photo-164353.jpeg');
  pineconeImg    = tryLoad('./zapfen.png',     'https://images.pexels.com/photos/380284/pexels-photo-380284.jpeg');
}

function tryLoad(localPath, fallback){
  let img;
  img = loadImage(localPath, ()=>{}, ()=>{ img = loadImage(fallback);} );
  return img;
}

/* ------------------   SETUP   --------------------------- */
function setup(){
  pixelDensity(1);                 // <‑‑ wichtige Änderung (Overlay füllt jetzt jedes Device)
  createCanvas(windowWidth, windowHeight);

  initGameVariables();

  // Fragen mischen
  shuffledQuestions = shuffle([...quizQuestions]);

  for(let i=0;i<3;i++){ spawnTree(width + i*300*scaleFactor);}  // erste Hindernisse
  textFont('Montserrat');
}

function initGameVariables(){
  scaleFactor  = min(windowWidth/800, windowHeight/600);
  birdX        = width/4;
  birdY        = height/2;
  birdVelocity = 0;
  gravity      = 0.5*scaleFactor;

  trees = [];
  pinecones = [];
  score = 0;
  obstaclesPassed = 0;
  gameState = 'start';
  correctAnswers = 0;
  totalQuestionsAnswered = 0;
  quizResultMessage = '';
  quizResultTimer = 0;
  obstaclePauseTimer = 0;
  restartDelayTimer = 0;
  gravityActive = false;
  startDelayTimer = 0;
  confettiPlayed = false;
}

/* ------------------   DRAW   ---------------------------- */
function draw(){
  clear();
  background(0,100,0);   // Fallback‑Hintergrund

  drawBackgroundImage();

  if(gameState==='start'){
    drawStartScreen();
  }
  else if(gameState==='playing'){
    drawGamePlay();
  }
  else if(gameState==='quiz'){
    drawQuiz();
  }
  else if(gameState==='quizResult'){
    drawQuizResult();
  }
  else if(gameState==='gameover'){
    drawGameOver();
  }
}

/* ----------  START‑SCREEN  ------------ */
function drawStartScreen(){
  // halbtransparentes Overlay über den GESAMTEN Bildschirm
  fill(0,0,0,200);
  rect(0,0,width,height,15);

  textAlign(CENTER);
  drawingContext.shadowBlur  = 10;
  drawingContext.shadowColor = 'rgba(255,255,255,0.5)';
  fill(255);
  textSize(48*scaleFactor);
  text('Kolebri ‑ The Game', width/2, height/3);
  drawingContext.shadowBlur  = 0;

  // Start‑Button
  const btnWidth  = max(200*scaleFactor,200);
  const btnHeight = max(60*scaleFactor,60);
  const btnX = width/2;
  const btnY = height/2 + 50*scaleFactor;
  const over = mouseX>btnX-btnWidth/2 && mouseX<btnX+btnWidth/2 && mouseY>btnY-btnHeight/2 && mouseY<btnY+btnHeight/2;
  const col  = over ? color(92,46,13) : color(139,69,19);

  drawingContext.shadowBlur  = 10;
  drawingContext.shadowColor = 'rgba(0,0,0,0.3)';
  fill(col);
  noStroke();
  rectMode(CENTER);
  rect(btnX,btnY,btnWidth,btnHeight,15);
  drawingContext.shadowBlur  = 0;

  drawingContext.shadowBlur  = 5;
  drawingContext.shadowColor = 'rgba(0,0,0,0.5)';
  fill(255);
  textSize(24*scaleFactor);
  text('Spiel Starten',btnX,btnY+7*scaleFactor);
  drawingContext.shadowBlur  = 0;
}

/* ----------  QUIZ‑SCREEN  ------------- */
function drawQuiz(){
  if(quizFade<1){quizFade = min(quizFade+0.02,1);}  // sanftes Ein‑blenden

  // Abdunkeln
  fill(0,0,0,200*quizFade);
  rect(0,0,width,height);

  // Frage‑Box
  const qBoxWidth  = width*0.8;
  const qBoxHeight = height*0.15;
  const qBoxX=width/2, qBoxY = height/4;

  drawingContext.shadowBlur  = 10;
  drawingContext.shadowColor = 'rgba(0,0,0,0.3)';
  fill(255,255*quizFade);
  rectMode(CENTER);
  rect(qBoxX,qBoxY,qBoxWidth,qBoxHeight,15);
  drawingContext.shadowBlur = 0;

  // Frage‑Text
  textAlign(CENTER);
  const questionText = quiz?.question ?? 'Frage fehlt';
  const baseFontSize = 28*scaleFactor;
  textSize(baseFontSize);
  let maxWidth = qBoxWidth*0.9;
  let fs = baseFontSize;
  if(textWidth(questionText)>maxWidth){ fs = max(baseFontSize*(maxWidth/textWidth(questionText)), 16*scaleFactor); }
  textSize(fs);
  fill(0);
  drawingContext.shadowBlur  = 5;
  drawingContext.shadowColor = 'rgba(0,0,0,0.5)';
  text(questionText,qBoxX,qBoxY+10*scaleFactor);
  drawingContext.shadowBlur  = 0;

  // Antwort‑Buttons
  const btnWidth   = max(350*scaleFactor,250);
  const btnHeight  = max(70*scaleFactor,60);
  const spacing    = btnHeight + 20*scaleFactor;  // **NEU: extra Abstand**
  const startY     = height/2 - 1.5*spacing;      // zentriert 4 Buttons

  const buttonGradients = [
    [color(255,99,71),  color(255,140,0)],
    [color(50,205,50),  color(0,255,127)],
    [color(30,144,255), color(0,191,255)],
    [color(255,215,0),  color(255,165,0)]
  ];

  // Schriftgröße innerhalb Buttons
  const longest   = quiz.options.reduce((a,b)=> a.length>b.length?a:b,'');
  const baseAnsFS = 24*scaleFactor;
  textSize(baseAnsFS);
  let ansFS = baseAnsFS;
  if(textWidth(longest) > btnWidth*0.9){ ansFS = max(baseAnsFS*(btnWidth*0.9/textWidth(longest)),14*scaleFactor);}  

  for(let i=0;i<quiz.options.length;i++){
    const x = width/2;
    const y = startY + i*spacing;
    const over = mouseX>x-btnWidth/2 && mouseX<x+btnWidth/2 && mouseY>y-btnHeight/2 && mouseY<y+btnHeight/2;

    drawingContext.shadowBlur  = 10;
    drawingContext.shadowColor = 'rgba(0,0,0,0.3)';
    const grad = drawingContext.createLinearGradient(x-btnWidth/2,y,x+btnWidth/2,y);
    grad.addColorStop(0,buttonGradients[i][0]);
    grad.addColorStop(1,buttonGradients[i][1]);
    drawingContext.fillStyle = grad;

    const scale = over ? 1.05 : 1;   // kleiner Hover‑Effekt

    rectMode(CENTER);
    rect(x,y,btnWidth*scale,btnHeight*scale,15);
    drawingContext.shadowBlur = 0;

    // Text
    drawingContext.shadowBlur  = 5;
    drawingContext.shadowColor = 'rgba(0,0,0,0.5)';
    fill(255,255*quizFade);
    textSize(ansFS);
    text(quiz.options[i],x,y+8*scaleFactor);
    drawingContext.shadowBlur = 0;
  }

  // Timer‑Bar
  const barWidth  = max(300*scaleFactor,200);
  const barHeight = max(20*scaleFactor,15);
  const barX=width/2, barY = height - 60*scaleFactor;
  let progress = quizTimer/(15*60);
  let filled   = barWidth*progress;

  drawingContext.shadowBlur  = 5;
  drawingContext.shadowColor = 'rgba(0,0,0,0.3)';
  fill(100);
  rect(barX,barY,barWidth,barHeight,10);
  let g = drawingContext.createLinearGradient(barX-barWidth/2,barY,barX+barWidth/2,barY);
  g.addColorStop(0,color(255,99,71));
  g.addColorStop(1,color(255,215,0));
  drawingContext.fillStyle = g;
  rectMode(CORNER);
  rect(barX-barWidth/2,barY-barHeight/2,filled,barHeight,10);
  rectMode(CENTER);
  drawingContext.shadowBlur = 0;

  fill(255);
  textSize(16*scaleFactor);
  text(ceil(quizTimer/60),barX,barY+5*scaleFactor);

  if(--quizTimer<=0){
    gameState='playing';
    quiz=null;
    obstaclePauseTimer=120;
  }
}

/* ----------  SONSTIGE FUNKTIONEN (unverändert) ---------- */
// > Hier folgen drawBackgroundImage(), drawGamePlay(), drawQuizResult(), drawGameOver(),
//   startGame(), spawnTree(), startQuiz(), resetGame(), windowResized(), handleInput() usw.
//   Sie wurden aus Platzgründen nicht verändert; kopiere einfach deinen Original‑Code hierher
//   ODER belasse ihn wie gehabt, solange er nicht mit den Änderungen kollidiert.

function drawBackgroundImage(){
  const img = bgImg;
  if(!img||img.width===0) return;
  let imgAspect = img.width/img.height;
  let canvAspect = width/height;
  let iw,ih,ix,iy;
  if(imgAspect>canvAspect){ ih=height; iw=ih*imgAspect; ix=(width-iw)/2; iy=0; }
  else{ iw=width; ih=iw/imgAspect; ix=0; iy=(height-ih)/2; }
  image(img,ix,iy,iw,ih);
}

/* --------------------------------------------------------- */
function windowResized(){
  resizeCanvas(windowWidth,windowHeight);
  scaleFactor = min(windowWidth/800, windowHeight/600);
}

</script>
</body>
</html>
