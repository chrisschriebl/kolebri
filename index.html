<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kolebri – The Game</title>
  <style>
    /* ---------- GLOBAL -------------------------------------------------- */
    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      overflow:hidden;
      touch-action:none;
      font-family:"Montserrat",sans-serif;
    }

    /* Canvas NICHT skalieren – echte p5-Pixel == sichtbare Pixel */
    canvas{display:block;}
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
</head>
<body>
<script>
/* -----------------------------------------------------------------------
             KOLEBRI  –  THE  GAME   (RESPONSIVE / BUG‑FIX EDITION)
   ----------------------------------------------------------------------- */

/* =========================  SPIELVARIABLEN  ========================= */
let bird, treeImg, upperTreeImg, pineconeImg, bgImg;
let newBird;
let birdX, birdY, birdVelocity, gravity;
let trees = [], pinecones = [];
let score = 0;
let gameState = 'start';
let quiz = null, quizTimer = 0, quizFade = 0;
let obstaclesPassed = 0;
let hoverIndex = -1;
let scaleFactor = 1;
let confetti = [], confettiPlayed = false;
let correctAnswers = 0, totalQuestionsAnswered = 0;
let quizResultMessage = '', quizResultTimer = 0;
let shuffledQuestions = [], currentQuestionIndex = 0;
let obstaclePauseTimer = 0, restartDelayTimer = 0;
let gravityActive = false, startDelayTimer = 0;

/* =========================  QUIZ‑FRAGEN  ============================ */
const quizQuestions = [
  {question:"Welcher Baum verströmt im Sommer einen besonders süßen Duft?",options:["Birke","Ahorn","Linde","Tanne"],correct:2},
  {question:"Welcher Baum hat weiße, schimmernde Rinde?",options:["Buche","Birke","Eiche","Hainbuche"],correct:1},
  {question:"Welcher Baum verliert als Nadelbaum im Herbst seine Nadeln?",options:["Fichte","Kiefer","Tanne","Lärche"],correct:3},
  {question:"Welche Baumart bildet kleine „Propeller“-Samen aus?",options:["Eiche","Tulpenbaum","Ahorn","Hainbuche"],correct:2},
  {question:"Welcher Baum hat tief eingeschnittene Blätter und bildet Eicheln?",options:["Ahorn","Buche","Eiche","Kirsche"],correct:2},
  {question:"Welcher Baum hat auffällige, trompetenförmige Blüten?",options:["Linde","Tulpenbaum","Ahorn","Tanne"],correct:1},
  {question:"Welcher Baum ist mit Weihnachten besonders verbunden?",options:["Tanne","Birke","Kirsche","Linde"],correct:0},
  {question:"Welche Blätter sind herzförmig?",options:["Eichenblätter","Lindenblätter","Ahornblätter","Buchenblätter"],correct:1},
  {question:"Welche Baumart hat eine sehr dichte Krone und ledrige Blätter?",options:["Hainbuche","Ahorn","Kirsche","Birke"],correct:0},
  {question:"Welcher Baum ist im Frühling mit rosa oder weißen Blüten bedeckt?",options:["Tulpenbaum","Buche","Kirsche","Weide"],correct:2},
  {question:"Welche Baumart ist besonders biegsam und oft in Wassernähe zu finden?",options:["Linde","Birke","Weide","Buche"],correct:2},
  {question:"Wie viele unterschiedliche Baumarten kann man entlang des Lehrpfades entdecken?",options:["7","9","11","13"],correct:2},
  {question:"Welche Baumart ist sowohl in Baumraum 1 und 2 als auch 3 vertreten?",options:["Tanne","Tulpenbaum","Birke","Kirsche"],correct:2},
  {question:"Wo beginnt der Baumlehrpfad?",options:["Bei der Turnhalle","Beim Schulbüro","Beim JUZ / Parkplatz","Beim Fußballfeld"],correct:2},
  {question:"Welche Baumart hat eine besonders glatte und graue Rinde?",options:["Hainbuche","Buche","Eiche","Ahorn"],correct:1}
];

/* =========================  PRELOAD  ================================ */
function preload(){
  bgImg        = tryLoad('./background.jpg',  'https://images.pexels.com/photos/38136/pexels-photo-38136.jpeg');
  treeImg      = tryLoad('./stammunten.png', 'https://images.pexels.com/photos/1612351/pexels-photo-1612351.jpeg');
  upperTreeImg = tryLoad('./stammoben.png',  'https://images.pexels.com/photos/164353/pexels-photo-164353.jpeg');
  pineconeImg  = tryLoad('./zapfen.png',     'https://images.pexels.com/photos/380284/pexels-photo-380284.jpeg');
}
function tryLoad(localPath,fallback){
  let img = loadImage(localPath,()=>{},()=>{ img = loadImage(fallback);});
  return img;
}

/* =========================  SETUP  ================================= */
function setup(){
  pixelDensity(1);                      // *** WICHTIG: echte Pixel ***
  createCanvas(windowWidth, windowHeight);
  initGameVariables();
  shuffledQuestions = shuffle([...quizQuestions]);
  for(let i=0;i<3;i++){ spawnTree(width + i*300*scaleFactor); }
  textFont('Montserrat');
}
function initGameVariables(){
  scaleFactor  = min(windowWidth/800, windowHeight/600);
  birdX        = width/4;
  birdY        = height/2;
  birdVelocity = 0;
  gravity      = 0.5*scaleFactor;
  trees.length = 0;
  pinecones.length = 0;
  score = 0;
  obstaclesPassed = 0;
  gameState = 'start';
  correctAnswers = 0;
  totalQuestionsAnswered = 0;
  quizResultMessage = '';
  quizResultTimer = 0;
  obstaclePauseTimer = 0;
  restartDelayTimer = 0;
  gravityActive = false;
  startDelayTimer = 0;
  confetti.length = 0;
  confettiPlayed = false;
  quiz = null;
  quizTimer = 0;
  quizFade = 0;
  currentQuestionIndex = 0;
}

/* =========================  DRAW  ================================== */
function draw(){
  clear();
  background(0,100,0);
  drawBackgroundImage();

  switch(gameState){
    case 'start':       drawStartScreen();    break;
    case 'playing':     drawGamePlay();       break;
    case 'quiz':        drawQuiz();           break;
    case 'quizResult':  drawQuizResult();     break;
    case 'gameover':    drawGameOver();       break;
  }
}

/* ---------- HINTERGRUND ------------------------------------------- */
function drawBackgroundImage(){
  if(!bgImg||bgImg.width===0) return;
  const imgAspect = bgImg.width/bgImg.height;
  const canvAspect= width/height;
  let iw,ih,ix,iy;
  if(imgAspect>canvAspect){ ih=height; iw=ih*imgAspect; ix=(width-iw)/2; iy=0; }
  else{ iw=width; ih=iw/imgAspect; ix=0; iy=(height-ih)/2; }
  image(bgImg,ix,iy,iw,ih);
}

/* ---------- START‑SCREEN ------------------------------------------ */
function drawStartScreen(){
  fill(0,0,0,200);  rect(0,0,width,height,15);
  textAlign(CENTER);
  drawingContext.shadowBlur  = 10;
  drawingContext.shadowColor = 'rgba(255,255,255,0.5)';
  fill(255);
  textSize(48*scaleFactor);
  text('Kolebri – The Game', width/2, height/3);
  drawingContext.shadowBlur  = 0;

  const btnWidth  = max(200*scaleFactor,200);
  const btnHeight = max(60*scaleFactor,60);
  const btnX=width/2, btnY=height/2+50*scaleFactor;
  const over = mouseX>btnX-btnWidth/2 && mouseX<btnX+btnWidth/2 && mouseY>btnY-btnHeight/2 && mouseY<btnY+btnHeight/2;
  const col = over?color(92,46,13):color(139,69,19);

  drawingContext.shadowBlur  = 10;
  drawingContext.shadowColor = 'rgba(0,0,0,0.3)';
  fill(col);  noStroke();  rectMode(CENTER);  rect(btnX,btnY,btnWidth,btnHeight,15);
  drawingContext.shadowBlur  = 0;

  drawingContext.shadowBlur  = 5;
  drawingContext.shadowColor = 'rgba(0,0,0,0.5)';
  fill(255);  textSize(24*scaleFactor);  text('Spiel Starten',btnX,btnY+7*scaleFactor);
  drawingContext.shadowBlur  = 0;
}

/* ---------- GAMEPLAY ---------------------------------------------- */
function drawGamePlay(){
  if(startDelayTimer>0){ if(--startDelayTimer<=0) gravityActive=true; }
  if(gravityActive){ birdVelocity+=gravity; birdY+=birdVelocity; }

  // Vogel zeichnen
  if(newBird&&newBird.width>0){ image(newBird,birdX-25*scaleFactor,birdY-25*scaleFactor,50*scaleFactor,50*scaleFactor); }
  else{ fill(255,0,0); rect(birdX-25*scaleFactor,birdY-25*scaleFactor,50*scaleFactor,50*scaleFactor); }

  // Kollision oben/unten
  if(birdY>height||birdY<0){ resetGame(); }

  /* ---- Hindernisse ---- */
  for(let i=trees.length-1;i>=0;i--){
    let t=trees[i];
    t.x-=2*scaleFactor;
    // oben
    if(upperTreeImg&&upperTreeImg.width>0) image(upperTreeImg,t.x,0,100*scaleFactor,t.gapY-100*scaleFactor);
    else if(treeImg&&treeImg.width>0)      image(treeImg      ,t.x,0,100*scaleFactor,t.gapY-100*scaleFactor);
    else{ fill(0,128,0); rect(t.x,0,100*scaleFactor,t.gapY-100*scaleFactor); }
    // unten
    if(treeImg&&treeImg.width>0) image(treeImg,t.x,t.gapY+150*scaleFactor,100*scaleFactor,height-(t.gapY+150*scaleFactor));
    else{ fill(0,128,0); rect(t.x,t.gapY+150*scaleFactor,100*scaleFactor,height-(t.gapY+150*scaleFactor)); }

    // Kollision
    if(birdX+25*scaleFactor>t.x && birdX-25*scaleFactor<t.x+100*scaleFactor){
      if(birdY-25*scaleFactor<t.gapY-100*scaleFactor || birdY+25*scaleFactor>t.gapY+150*scaleFactor){ resetGame(); }
    }
    // Punkte
    if(!t.passed && birdX>t.x+100*scaleFactor){ score++; t.passed=true; obstaclesPassed++; if(obstaclesPassed%3===0){ startQuiz(); }}
    if(t.x<-100*scaleFactor) trees.splice(i,1);
  }
  if(trees.length<3&&obstaclePauseTimer<=0) spawnTree(width);
  if(obstaclePauseTimer>0) obstaclePauseTimer--;

  /* ---- Zapfen ---- */
  for(let i=pinecones.length-1;i>=0;i--){
    let p=pinecones[i];
    p.x-=2*scaleFactor;
    if(pineconeImg&&pineconeImg.width>0) image(pineconeImg,p.x,p.y,30*scaleFactor,30*scaleFactor);
    if(birdX+25*scaleFactor>p.x && birdX-25*scaleFactor<p.x+30*scaleFactor && birdY+25*scaleFactor>p.y && birdY-25*scaleFactor<p.y+30*scaleFactor){ score+=5; pinecones.splice(i,1);}    
    if(p.x<-30*scaleFactor) pinecones.splice(i,1);
  }

  /* ---- HUD ---- */
  drawingContext.shadowBlur  = 5;
  drawingContext.shadowColor = 'rgba(0,0,0,0.5)';
  fill(255); textSize(32*scaleFactor); text(`Punkte: ${score}`, width-150*scaleFactor,40*scaleFactor);
  drawingContext.shadowBlur  = 0;
}

/* ---------- QUIZ --------------------------------------------------- */
function drawQuiz(){
  if(quizFade<1) quizFade = min(quizFade+0.02,1);
  fill(0,0,0,200*quizFade); rect(0,0,width,height);

  const qBoxW=width*0.8, qBoxH=height*0.15, qBoxX=width/2, qBoxY=height/4;
  drawingContext.shadowBlur  = 10;
  drawingContext.shadowColor = 'rgba(0,0,0,0.3)';
  fill(255,255*quizFade); rectMode(CENTER); rect(qBoxX,qBoxY,qBoxW,qBoxH,15); drawingContext.shadowBlur=0;

  // Frage
  textAlign(CENTER);
  let qText=quiz.question;
  let baseFS=28*scaleFactor; textSize(baseFS);
  let maxW=qBoxW*0.9; if(textWidth(qText)>maxW) textSize(max(baseFS*(maxW/textWidth(qText)),16*scaleFactor));
  fill(0); drawingContext.shadowBlur  = 5; drawingContext.shadowColor='rgba(0,0,0,0.5)';
  text(qText,qBoxX,qBoxY+10*scaleFactor); drawingContext.shadowBlur=0;

  // Buttons ---------------------------------------------------------
  const btnW=max(350*scaleFactor,250), btnH=max(70*scaleFactor,60);
  const spacing=btnH+20*scaleFactor;              // **extra Abstand**
  const startY=height/2-spacing*1.5;               // zentriert 4 Buttons
  const grads=[[color(255,99,71),color(255,140,0)], [color(50,205,50),color(0,255,127)], [color(30,144,255),color(0,191,255)], [color(255,215,0),color(255,165,0)]];
  const longest=quiz.options.reduce((a,b)=>a.length>b.length?a:b,'');
  let ansFS=24*scaleFactor; textSize(ansFS); if(textWidth(longest)>btnW*0.9) ansFS=max(ansFS*(btnW*0.9/textWidth(longest)),14*scaleFactor);

  for(let i=0;i<4;i++){
    const x=width/2, y=startY+i*spacing;
    const over=mouseX>x-btnW/2 && mouseX<x+btnW/2 && mouseY>y-btnH/2 && mouseY<y+btnH/2;
    drawingContext.shadowBlur  = 10; drawingContext.shadowColor='rgba(0,0,0,0.3)';
    let g=drawingContext.createLinearGradient(x-btnW/2,y,x+btnW/2,y); g.addColorStop(0,grads[i][0]); g.addColorStop(1,grads[i][1]); drawingContext.fillStyle=g;
    rectMode(CENTER); rect(x,y,btnW*(over?1.05:1),btnH*(over?1.05:1),15); drawingContext.shadowBlur=0;

    drawingContext.shadowBlur=5; drawingContext.shadowColor='rgba(0,0,0,0.5)';
    fill(255,255*quizFade); textSize(ansFS); text(quiz.options[i],x,y+8*scaleFactor); drawingContext.shadowBlur=0;
  }

  // Timerleiste -----------------------------------------------------
  const barW=max(300*scaleFactor,200), barH=max(20*scaleFactor,15), barX=width/2, barY=height-60*scaleFactor;
  const progress=quizTimer/(15*60), filled=barW*progress;
  drawingContext.shadowBlur=5; drawingContext.shadowColor='rgba(0,0,0,0.3)';
  fill(100); rect(barX,barY,barW,barH,10);
  let g=drawingContext.createLinearGradient(barX-barW/2,barY,barX+barW/2,barY); g.addColorStop(0,color(255,99,71)); g.addColorStop(1,color(255,215,0)); drawingContext.fillStyle=g;
  rectMode(CORNER); rect(barX-barW/2,barY-barH/2,filled,barH,10); rectMode(CENTER); drawingContext.shadowBlur=0;
  fill(255); textSize(16*scaleFactor); text(ceil(quizTimer/60),barX,barY+5*scaleFactor);

  if(--quizTimer<=0){ gameState='playing'; quiz=null; obstaclePauseTimer=120; }
}

/* ---------- QUIZ‑ERGEBNIS ----------------------------------------- */
function drawQuizResult(){
  fill(0,0,0,200); rect(0,0,width,height);
  textAlign(CENTER); textSize(48*scaleFactor); drawingContext.shadowBlur=10; drawingContext.shadowColor='rgba(0,0,0,0.5)';
  fill(quizResultMessage==='Richtig!'?color(0,255,0):color(255,0,0));
  text(quizResultMessage, width/2, height/2); drawingContext.shadowBlur=0;
  if(--quizResultTimer<=0){
    if(totalQuestionsAnswered>=15) resetGame();
    else{ gameState='playing'; quiz=null; obstaclePauseTimer=120; }
  }
}

/* ---------- GAMEOVER ---------------------------------------------- */
function drawGameOver(){
  fill(0,200); rect(0,0,width,height);
  textAlign(CENTER); drawingContext.shadowBlur=5; drawingContext.shadowColor='rgba(0,0,0,0.5)'; fill(255);
  textSize(32*scaleFactor);
  text(`Punkte: ${score}`,                width/2, height/2-40*scaleFactor);
  text(`Richtige Fragen: ${correctAnswers}/15`, width/2, height/2);
  if(restartDelayTimer<=0) text('Drücke die Leertaste um neu zu starten', width/2, height/2+40*scaleFactor);
  else text(`Neustart möglich in ${ceil(restartDelayTimer/60)} Sekunden`, width/2, height/2+40*scaleFactor);
  drawingContext.shadowBlur=0;

  if(restartDelayTimer>0) restartDelayTimer--;

  if(!confettiPlayed && confetti.length===0){
    for(let i=0;i<100;i++){ confetti.push({x:random(width), y:random(-50,0), size:random(5,15)*scaleFactor, speed:random(2,5)*scaleFactor, color:color(random(255),random(255),random(255)), rot:random(TWO_PI), rotSpeed:random(-0.1,0.1)}); }
    confettiPlayed=true;
  }
  for(let i=confetti.length-1;i>=0;i--){ let c=confetti[i]; c.y+=c.speed; c.rot+=c.rotSpeed; push(); translate(c.x,c.y); rotate(c.rot); fill(c.color); rect(0,0,c.size,c.size); pop(); if(c.y>height) confetti.splice(i,1); }
}

/* =========================  EREIGNISSE  ============================ */
function keyPressed(){
  if(key===' '){
    if(gameState==='start') startGame();
    else if(gameState==='playing'){ if(startDelayTimer>0){ startDelayTimer=0; gravityActive=true;} birdVelocity=-8*scaleFactor; }
    else if(gameState==='gameover'&&restartDelayTimer<=0) setup();
  }
}
function mousePressed(){ handleInput(); }
function touchStarted(){ handleInput(); return false; }
function handleInput(){
  if(gameState==='start'){
    const btnW=max(200*scaleFactor,200), btnH=max(60*scaleFactor,60), btnX=width/2, btnY=height/2+50*scaleFactor;
    if(mouseX>btnX-btnW/2 && mouseX<btnX+btnW/2 && mouseY>btnY-btnH/2 && mouseY<btnY+btnH/2) startGame();
  }
  else if(gameState==='playing'){ if(startDelayTimer>0){ startDelayTimer=0; gravityActive=true;} birdVelocity=-8*scaleFactor; }
  else if(gameState==='quiz'&&quiz){
    const btnW=max(350*scaleFactor,250), btnH=max(70*scaleFactor,60), spacing=btnH+20*scaleFactor, startY=height/2-spacing*1.5;
    for(let i=0;i<4;i++){
      const x=width/2, y=startY+i*spacing;
      if(mouseX>x-btnW/2 && mouseX<x+btnW/2 && mouseY>y-btnH/2 && mouseY<y+btnH/2){
        totalQuestionsAnswered++; if(totalQuestionsAnswered>15) totalQuestionsAnswered=15;
        if(i===quiz.correct){ correctAnswers++; score+=10; quizResultMessage='Richtig!'; } else quizResultMessage='Falsch!';
        gameState='quizResult'; quizResultTimer=120; break;
      }
    }
  }
  else if(gameState==='gameover'&&restartDelayTimer<=0) setup();
}

/* =========================  GAMELOGIK  ============================= */
function startGame(){
  gameState='playing';
  newBird=loadImage('./bird.png',()=>{},()=>{ newBird=null; });
  startDelayTimer=120;
}
function spawnTree(x){
  const minGap=200*scaleFactor, maxGap=400*scaleFactor, diff=maxGap-minGap, difficulty=constrain(score/50,0,1);
  const gapSize=maxGap-diff*difficulty;
  const gapY=random(gapSize, height-gapSize-150*scaleFactor);
  trees.push({x,gapY,passed:false});
  if(random()<0.5) pinecones.push({x:x+150*scaleFactor, y:gapY+25*scaleFactor});
}
function startQuiz(){ if(currentQuestionIndex<shuffledQuestions.length){ quiz=shuffledQuestions[currentQuestionIndex++]; gameState='quiz'; quizTimer=15*60; quizFade=0; } else resetGame(); }
function resetGame(){ gameState='gameover'; confetti.length=0; confettiPlayed=false; restartDelayTimer=300; }

/* =========================  RESPONSIVE  ============================ */
function windowResized(){ resizeCanvas(windowWidth,windowHeight); scaleFactor=min(windowWidth/800, windowHeight/600); }
</script>
</body>
</html>
